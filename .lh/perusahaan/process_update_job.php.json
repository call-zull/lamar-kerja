{
    "sourceFile": "perusahaan/process_update_job.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1721748365472,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1721748365472,
            "name": "Commit-0",
            "content": "<?php\r\nsession_start();\r\nif (!isset($_SESSION['user_id']) || $_SESSION['role'] !== 'perusahaan') {\r\n    header('Location: ../auth/login.php');\r\n    exit;\r\n}\r\n\r\ninclude '../includes/db.php';\r\n\r\n// Fungsi untuk memperbarui lowongan pekerjaan\r\nfunction updateJob($pdo, $id, $nama_pekerjaan, $posisi, $kualifikasi, $prodi, $keahlian, $batas_waktu, $range_gajih, $jenis_kerja, $sistem_kerja, $jobdesk, $perusahaan_id)\r\n{\r\n    try {\r\n        // Mulai transaksi\r\n        $pdo->beginTransaction();\r\n\r\n        // Mengubah data prodi dan keahlian menjadi JSON\r\n        $prodi_json = json_encode($prodi);\r\n        $keahlian_json = json_encode($keahlian);\r\n\r\n        // Memperbarui lowongan pekerjaan di tabel lowongan_kerja\r\n        $sql = \"UPDATE lowongan_kerja SET \r\n            nama_pekerjaan = :nama_pekerjaan, \r\n            posisi = :posisi, \r\n            kualifikasi = :kualifikasi, \r\n            prodi = :prodi, \r\n            keahlian = :keahlian, \r\n            batas_waktu = :batas_waktu, \r\n            range_gajih = :range_gajih, \r\n            jenis_kerja = :jenis_kerja, \r\n            sistem_kerja = :sistem_kerja, \r\n            jobdesk = :jobdesk, \r\n            perusahaan_id = :perusahaan_id\r\n            WHERE id = :id\";\r\n        $stmt = $pdo->prepare($sql);\r\n        $stmt->bindParam(':nama_pekerjaan', $nama_pekerjaan);\r\n        $stmt->bindParam(':posisi', $posisi);\r\n        $stmt->bindParam(':kualifikasi', $kualifikasi);\r\n        $stmt->bindParam(':prodi', $prodi_json);\r\n        $stmt->bindParam(':keahlian', $keahlian_json);\r\n        $stmt->bindParam(':batas_waktu', $batas_waktu);\r\n        $stmt->bindParam(':range_gajih', $range_gajih);\r\n        $stmt->bindParam(':jenis_kerja', $jenis_kerja);\r\n        $stmt->bindParam(':sistem_kerja', $sistem_kerja);\r\n        $stmt->bindParam(':jobdesk', $jobdesk);\r\n        $stmt->bindParam(':perusahaan_id', $perusahaan_id);\r\n        $stmt->bindParam(':id', $id, PDO::PARAM_INT);\r\n        $stmt->execute();\r\n\r\n        // Komit transaksi\r\n        $pdo->commit();\r\n\r\n        return true;\r\n    } catch (Exception $e) {\r\n        // Rollback transaksi jika terjadi kesalahan\r\n        $pdo->rollBack();\r\n        // Simpan pesan kesalahan ke sesi\r\n        $_SESSION['error_message'] = \"Error updating job: \" . $e->getMessage();\r\n        return false;\r\n    }\r\n}\r\n\r\n// Memeriksa apakah perusahaan_id ada di tabel perusahaans dan mendapatkan informasi perusahaan\r\nfunction getPerusahaanInfo($pdo, $user_id)\r\n{\r\n    $sql = \"SELECT id FROM perusahaans WHERE user_id = :user_id\";\r\n    $stmt = $pdo->prepare($sql);\r\n    $stmt->bindParam(':user_id', $user_id, PDO::PARAM_INT);\r\n    $stmt->execute();\r\n    return $stmt->fetch(PDO::FETCH_ASSOC);\r\n}\r\n\r\n// Memeriksa apakah form telah disubmit\r\nif ($_SERVER['REQUEST_METHOD'] === 'POST') {\r\n    $id = $_POST['edit_id'];\r\n    $nama_pekerjaan = htmlspecialchars($_POST['edit_nama_pekerjaan']);\r\n    $posisi = htmlspecialchars($_POST['edit_posisi']);\r\n    $kualifikasi = htmlspecialchars($_POST['edit_kualifikasi']);\r\n    $prodi = json_decode($_POST['edit_prodi'], true); // Memastikan ini adalah array\r\n    $keahlian = json_decode($_POST['edit_keahlian'], true); // Mendekode string JSON\r\n    $batas_waktu = $_POST['edit_batas_waktu'];\r\n    $range_gajih = htmlspecialchars($_POST['edit_range_gajih']);\r\n    $jenis_kerja = $_POST['edit_jenis_kerja'];\r\n    $sistem_kerja = $_POST['edit_sistem_kerja'];\r\n    $jobdesk = htmlspecialchars($_POST['edit_jobdesk']);\r\n    $user_id = $_SESSION['user_id']; // Assuming the user_id is the logged-in user's ID\r\n\r\n    // Memeriksa apakah perusahaan_id ada di tabel perusahaans\r\n    $perusahaanInfo = getPerusahaanInfo($pdo, $user_id);\r\n    if (!$perusahaanInfo) {\r\n        $_SESSION['error_message'] = \"Perusahaan tidak ditemukan.\";\r\n        header('Location: lowongan_kerja.php');\r\n        exit;\r\n    }\r\n\r\n    $perusahaan_id = $perusahaanInfo['id'];\r\n\r\n    // Memperbarui lowongan pekerjaan di database\r\n    if (updateJob($pdo, $id, $nama_pekerjaan, $posisi, $kualifikasi, $prodi, $keahlian, $batas_waktu, $range_gajih, $jenis_kerja, $sistem_kerja, $jobdesk, $perusahaan_id)) {\r\n        $_SESSION['success_message'] = \"Lowongan berhasil diperbarui.\";\r\n        header('Location: lowongan_kerja.php');\r\n        exit;\r\n    } else {\r\n        header('Location: lowongan_kerja.php');\r\n        exit;\r\n    }\r\n}\r\n?>"
        }
    ]
}